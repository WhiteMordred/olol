{% extends 'base.html' %}

{% block title %}Playground - Ollama Sync{% endblock %}

{% block content %}
<h1 class="mb-4 cyber-heading"><i class="fas fa-play-circle me-2"></i>Playground</h1>

<div class="row mb-4">
    <div class="col-md-8 col-lg-9">
        <!-- Chat Interface -->
        <div class="cyber-panel">
            <div class="cyber-panel-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">
                        <i class="fas fa-comments me-2"></i>Chat avec
                        {% if selected_model %}
                            {{ selected_model }}
                        {% else %}
                            Mod√®le
                        {% endif %}
                    </span>
                </div>
                <div>
                    <button class="cyber-btn cyber-btn-sm" id="clearChatBtn" title="Effacer la conversation">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="cyber-btn cyber-btn-sm ms-2" id="exportChatBtn" title="Exporter la conversation">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="cyber-panel-body p-0">
                <div class="cyber-chat-container d-flex flex-column" id="chatContainer">
                    <div class="cyber-message ai">
                        <p class="mb-0">üëã Bonjour ! Je suis une IA bas√©e sur 
                        {% if selected_model %}
                            <strong>{{ selected_model }}</strong>
                        {% else %}
                            <strong>le mod√®le s√©lectionn√©</strong>
                        {% endif %}. Comment puis-je vous aider aujourd'hui ?</p>
                    </div>
                    
                    <!-- Messages will be added here dynamically -->
                    
                    <!-- Typing indicator (hidden by default) -->
                    <div class="cyber-message ai cyber-typing-indicator d-none">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <form id="chatForm" class="p-3 border-top">
                    <div class="cyber-input-group">
                        <textarea class="cyber-input" id="userInput" rows="2" placeholder="√âcrivez votre message ici..."></textarea>
                        <button class="cyber-btn" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 col-lg-3">
        <!-- Model Selection and Parameters -->
        <div class="cyber-panel mb-3">
            <div class="cyber-panel-header">
                <i class="fas fa-sliders-h me-2"></i>Param√®tres
            </div>
            <div class="cyber-panel-body">
                <div class="mb-3">
                    <label for="modelSelect" class="form-label">Mod√®le</label>
                    <select class="cyber-input form-select" id="modelSelect">
                        <option value="" {% if not selected_model %}selected{% endif %}>S√©lectionnez un mod√®le</option>
                        {% for model in models %}
                            <option value="{{ model.name }}" {% if selected_model == model.name %}selected{% endif %}>
                                {{ model.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="temperatureRange" class="form-label">Temp√©rature: <span id="temperatureValue">0.7</span></label>
                    <input type="range" class="cyber-range" min="0" max="2" step="0.1" value="0.7" id="temperatureRange">
                </div>
                
                <div class="mb-3">
                    <label for="maxTokens" class="form-label">Tokens max.</label>
                    <input type="number" class="cyber-input form-control" id="maxTokens" value="2048" min="1" max="4096">
                </div>
                
                <div class="mb-3">
                    <label for="topP" class="form-label">Top-P: <span id="topPValue">0.9</span></label>
                    <input type="range" class="cyber-range" min="0" max="1" step="0.05" value="0.9" id="topP">
                </div>
                
                <div class="mb-3">
                    <label for="presencePenalty" class="form-label">P√©nalit√© de pr√©sence: <span id="presencePenaltyValue">0</span></label>
                    <input type="range" class="cyber-range" min="-2" max="2" step="0.1" value="0" id="presencePenalty">
                </div>
                
                <div class="mb-3">
                    <label for="frequencyPenalty" class="form-label">P√©nalit√© de fr√©quence: <span id="frequencyPenaltyValue">0</span></label>
                    <input type="range" class="cyber-range" min="-2" max="2" step="0.1" value="0" id="frequencyPenalty">
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" value="" id="streamToggle" checked>
                    <label class="form-check-label" for="streamToggle">
                        Streaming
                    </label>
                </div>
            </div>
        </div>
        
        <div class="cyber-panel">
            <div class="cyber-panel-header">
                <i class="fas fa-server me-2"></i>Serveur actif
            </div>
            <div class="cyber-panel-body p-2">
                <div class="d-flex align-items-center">
                    <span class="cyber-dot online me-2"></span>
                    <span class="server-name">localhost:50051</span>
                </div>
                <div class="mt-2">
                    <div class="cyber-progress">
                        <div class="cyber-progress-bar good" style="width: 25%"></div>
                    </div>
                    <div class="d-flex justify-content-between small mt-1">
                        <span>Charge: 25%</span>
                        <span>Latence: 42ms</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Popular Models Section -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3 cyber-heading-sm"><i class="fas fa-star me-2"></i>Mod√®les populaires</h4>
    </div>
    
    {% for model in models[:4] %}
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="cyber-model-card {% if selected_model == model.name %}active{% endif %}" 
             data-model-name="{{ model.name }}">
            <div class="cyber-model-body">
                <h5 class="cyber-model-name">{{ model.name }}</h5>
                <div class="mb-2">
                    <span class="cyber-badge">{{ model.servers|length }} serveur(s)</span>
                    {% if model.available %}
                    <span class="cyber-badge online">
                        <span class="cyber-dot"></span> Disponible
                    </span>
                    {% else %}
                    <span class="cyber-badge offline">
                        <span class="cyber-dot"></span> Non disponible
                    </span>
                    {% endif %}
                </div>
                <button class="cyber-btn cyber-btn-sm" onclick="selectModel('{{ model.name }}')">
                    S√©lectionner
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Toast pour les notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="cyber-toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="cyber-toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <small id="toastTime">√Ä l'instant</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="cyber-toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const chatContainer = document.getElementById('chatContainer');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const modelSelect = document.getElementById('modelSelect');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const exportChatBtn = document.getElementById('exportChatBtn');
    const temperatureRange = document.getElementById('temperatureRange');
    const temperatureValue = document.getElementById('temperatureValue');
    const topP = document.getElementById('topP');
    const topPValue = document.getElementById('topPValue');
    const presencePenalty = document.getElementById('presencePenalty');
    const presencePenaltyValue = document.getElementById('presencePenaltyValue');
    const frequencyPenalty = document.getElementById('frequencyPenalty');
    const frequencyPenaltyValue = document.getElementById('frequencyPenaltyValue');
    const modelCards = document.querySelectorAll('.cyber-model-card');
    
    // Update range values
    temperatureRange.addEventListener('input', function() {
        temperatureValue.textContent = this.value;
    });
    
    topP.addEventListener('input', function() {
        topPValue.textContent = this.value;
    });
    
    presencePenalty.addEventListener('input', function() {
        presencePenaltyValue.textContent = this.value;
    });
    
    frequencyPenalty.addEventListener('input', function() {
        frequencyPenaltyValue.textContent = this.value;
    });
    
    // Handle chat submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userMessage = userInput.value.trim();
        if (!userMessage) return;
        
        // Add user message
        addMessage('user', userMessage);
        userInput.value = '';
        
        // Get selected model
        const selectedModel = modelSelect.value;
        if (!selectedModel) {
            showToast('Erreur', 'Veuillez s√©lectionner un mod√®le', 'danger');
            return;
        }
        
        // Get parameters
        const params = {
            model: selectedModel,
            temperature: parseFloat(temperatureRange.value),
            top_p: parseFloat(topP.value),
            max_tokens: parseInt(document.getElementById('maxTokens').value),
            presence_penalty: parseFloat(presencePenalty.value),
            frequency_penalty: parseFloat(frequencyPenalty.value),
            stream: document.getElementById('streamToggle').checked
        };
        
        // Show typing indicator
        const typingIndicator = document.querySelector('.cyber-typing-indicator');
        typingIndicator.classList.remove('d-none');
        
        // Simulate API call (replace with actual API call)
        setTimeout(function() {
            typingIndicator.classList.add('d-none');
            
            // Add AI response (replace with actual response)
            let response = "Voici une r√©ponse simul√©e du mod√®le " + selectedModel + ". ";
            response += "Dans une impl√©mentation r√©elle, cette r√©ponse viendrait de l'API Ollama. ";
            response += "Vous pouvez ajuster les param√®tres √† droite pour modifier le comportement du mod√®le.";
            
            addMessage('ai', response);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 1500);
    });
    
    // Clear chat
    clearChatBtn.addEventListener('click', function() {
        if (confirm('Voulez-vous vraiment effacer toute la conversation?')) {
            // Remove all messages except the first one (greeting) and the typing indicator
            const messages = chatContainer.querySelectorAll('.cyber-message');
            for (let i = 1; i < messages.length; i++) {
                if (!messages[i].classList.contains('cyber-typing-indicator')) {
                    messages[i].remove();
                }
            }
        }
    });
    
    // Export chat
    exportChatBtn.addEventListener('click', function() {
        const messages = [];
        const messageElements = chatContainer.querySelectorAll('.cyber-message');
        
        messageElements.forEach(el => {
            if (!el.classList.contains('cyber-typing-indicator')) {
                const type = el.classList.contains('user') ? 'user' : 'ai';
                const content = el.textContent.trim();
                messages.push({ type, content });
            }
        });
        
        const exportData = {
            timestamp: new Date().toISOString(),
            model: modelSelect.value || 'non sp√©cifi√©',
            conversation: messages
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-export-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    // Model selection from cards
    modelCards.forEach(card => {
        card.addEventListener('click', function() {
            const modelName = this.dataset.modelName;
            selectModel(modelName);
        });
    });
    
    // Helper functions
    function addMessage(type, content) {
        const message = document.createElement('div');
        message.classList.add('cyber-message');
        message.classList.add(type);
        
        const paragraph = document.createElement('p');
        paragraph.classList.add('mb-0');
        paragraph.textContent = content;
        
        message.appendChild(paragraph);
        
        // Insert before typing indicator
        const typingIndicator = document.querySelector('.cyber-typing-indicator');
        chatContainer.insertBefore(message, typingIndicator);
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function showToast(title, message, type = 'info') {
        const toastEl = document.getElementById('notificationToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastTime = document.getElementById('toastTime');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        toastTime.textContent = '√Ä l\'instant';
        
        // Set toast color based on type
        toastEl.classList.remove('success', 'danger', 'warning', 'info');
        toastEl.classList.add(type);
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
});

// Global function for model selection
function selectModel(modelName) {
    const modelSelect = document.getElementById('modelSelect');
    modelSelect.value = modelName;
    
    // Update model cards
    document.querySelectorAll('.cyber-model-card').forEach(card => {
        if (card.dataset.modelName === modelName) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    // Update chat header
    const chatHeader = document.querySelector('.cyber-panel-header .fw-bold');
    chatHeader.innerHTML = `<i class="fas fa-comments me-2"></i>Chat avec ${modelName}`;
}
</script>
{% endblock %}
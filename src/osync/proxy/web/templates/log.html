{% extends "base.html" %}

{% block title %}Journaux - Ollama Sync{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="mb-4">
            <i class="fas fa-clipboard-list me-2"></i> Journaux système
        </h2>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Logs du système</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-primary" id="refresh-logs">
                        <i class="fas fa-sync-alt"></i> Rafraîchir
                    </button>
                    <button class="btn btn-sm btn-secondary dropdown-toggle" id="log-level-dropdown" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                        Niveau: INFO
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="log-level-dropdown">
                        <li><a class="dropdown-item" href="#" data-level="DEBUG">DEBUG</a></li>
                        <li><a class="dropdown-item" href="#" data-level="INFO">INFO</a></li>
                        <li><a class="dropdown-item" href="#" data-level="WARNING">WARNING</a></li>
                        <li><a class="dropdown-item" href="#" data-level="ERROR">ERROR</a></li>
                        <li><a class="dropdown-item" href="#" data-level="CRITICAL">CRITICAL</a></li>
                    </ul>
                    <button class="btn btn-sm btn-outline-secondary" id="toggle-autoscroll">
                        <i class="fas fa-scroll"></i> Auto-défil
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="log-container" id="log-container">
                    <div class="log-filters mb-2 p-2">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="log-search" placeholder="Filtrer les logs...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                    <select class="form-select" id="log-component">
                                        <option value="">Tous les composants</option>
                                        <option value="osync.proxy.app">Proxy</option>
                                        <option value="osync.utils.cluster">Cluster</option>
                                        <option value="osync.sync.client">Client</option>
                                        <option value="osync.rpc.client">RPC</option>
                                        <option value="osync.proxy.cluster.health">Santé</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="datetime-local" class="form-control" id="log-date">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-secondary w-100" id="clear-filters">
                                    <i class="fas fa-eraser"></i> Effacer
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="log-entries" id="log-entries">
                        <pre class="log-content" id="log-content">
<!-- Les logs seront chargés dynamiquement ici -->
<div class="text-center p-3 loading-indicator">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-2">Chargement des journaux...</p>
</div>
                        </pre>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <div>
                    <small>Taille du fichier: <span id="log-size">-</span></small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-danger" id="clear-logs">
                        <i class="fas fa-trash"></i> Effacer les logs
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="download-logs">
                        <i class="fas fa-download"></i> Télécharger
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i> Distribution des niveaux de log
            </div>
            <div class="card-body">
                <canvas id="log-level-chart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i> Activité par composant
            </div>
            <div class="card-body">
                <canvas id="log-component-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    const refreshBtn = document.getElementById('refresh-logs');
    const logSearch = document.getElementById('log-search');
    const logEntries = document.getElementById('log-entries');
    const logContent = document.getElementById('log-content');
    const toggleAutoscroll = document.getElementById('toggle-autoscroll');
    const logComponentSelect = document.getElementById('log-component');
    const logDateInput = document.getElementById('log-date');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const downloadBtn = document.getElementById('download-logs');
    const clearLogsBtn = document.getElementById('clear-logs');
    const levelDropdown = document.querySelectorAll('[data-level]');
    const logSizeSpan = document.getElementById('log-size');
    
    // Configuration
    let currentLogLevel = 'INFO';
    let autoScroll = true;
    let logData = [];
    let filteredLogData = [];
    
    // Configuration des graphiques
    let levelChart, componentChart;
    
    // Initialisation des graphiques
    function initCharts() {
        // Graphique de distribution des niveaux de log
        const levelCtx = document.getElementById('log-level-chart').getContext('2d');
        levelChart = new Chart(levelCtx, {
            type: 'doughnut',
            data: {
                labels: ['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'],
                datasets: [{
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: [
                        '#0dcaf0',  // DEBUG - info-light
                        '#20c997',  // INFO - success
                        '#ffc107',  // WARNING - warning
                        '#dc3545',  // ERROR - danger
                        '#6610f2'   // CRITICAL - purple
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // Graphique d'activité par composant
        const componentCtx = document.getElementById('log-component-chart').getContext('2d');
        componentChart = new Chart(componentCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Entrées de log',
                    data: [],
                    backgroundColor: '#6f42c1',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Chargement des données de log depuis le serveur
    function loadLogs() {
        // Afficher l'indicateur de chargement
        logContent.innerHTML = `
            <div class="text-center p-3 loading-indicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Chargement des journaux...</p>
            </div>
        `;
        
        // Faire une requête AJAX pour récupérer les logs
        fetch('/api/logs?level=' + currentLogLevel)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des logs');
                }
                return response.json();
            })
            .then(data => {
                logData = data.logs || [];
                logSizeSpan.textContent = data.file_size || '-';
                
                // Appliquer les filtres
                applyFilters();
                
                // Mettre à jour les graphiques
                updateCharts(data);
                
                // Afficher un toast de succès
                showToast('Logs actualisés', 'Les journaux ont été mis à jour avec succès');
            })
            .catch(error => {
                console.error('Erreur:', error);
                
                // Afficher un message d'erreur
                logContent.innerHTML = `
                    <div class="text-center p-3 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Impossible de charger les journaux.<br>
                        Erreur: ${error.message}</p>
                        <button class="btn btn-sm btn-primary" onclick="location.reload()">
                            Réessayer
                        </button>
                    </div>
                `;
                
                // Afficher un toast d'erreur
                showToast('Erreur', 'Impossible de charger les journaux: ' + error.message, 'error');
            });
    }
    
    // Appliquer les filtres sur les logs
    function applyFilters() {
        const searchTerm = logSearch.value.toLowerCase();
        const componentFilter = logComponentSelect.value;
        const dateFilter = logDateInput.value ? new Date(logDateInput.value) : null;
        
        // Filtrer les données
        filteredLogData = logData.filter(log => {
            // Filtre de recherche textuelle
            if (searchTerm && !log.message.toLowerCase().includes(searchTerm) && 
                !log.component.toLowerCase().includes(searchTerm)) {
                return false;
            }
            
            // Filtre par composant
            if (componentFilter && log.component !== componentFilter) {
                return false;
            }
            
            // Filtre par date
            if (dateFilter) {
                const logDate = new Date(log.timestamp);
                if (logDate.getDate() !== dateFilter.getDate() || 
                    logDate.getMonth() !== dateFilter.getMonth() || 
                    logDate.getFullYear() !== dateFilter.getFullYear()) {
                    return false;
                }
            }
            
            return true;
        });
        
        // Afficher les logs filtrés
        renderLogs();
    }
    
    // Afficher les logs dans l'interface
    function renderLogs() {
        if (filteredLogData.length === 0) {
            logContent.innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <p>Aucun journal correspondant aux critères de filtrage.</p>
                </div>
            `;
            return;
        }
        
        let logHtml = '';
        
        filteredLogData.forEach(log => {
            let levelClass = '';
            switch (log.level) {
                case 'DEBUG': levelClass = 'text-info'; break;
                case 'INFO': levelClass = 'text-success'; break;
                case 'WARNING': levelClass = 'text-warning'; break;
                case 'ERROR': levelClass = 'text-danger'; break;
                case 'CRITICAL': levelClass = 'text-purple'; break;
            }
            
            const date = new Date(log.timestamp);
            const timeStr = date.toLocaleTimeString();
            
            logHtml += `<span class="${levelClass}">${log.level}:</span><span class="text-muted">[${timeStr}]</span> ${log.component}: ${log.message}\n`;
        });
        
        logContent.innerHTML = logHtml;
        
        // Défiler vers le bas si activé
        if (autoScroll) {
            logEntries.scrollTop = logEntries.scrollHeight;
        }
        
        // Coloriser les niveaux de log
        colorizeLogLevels();
    }
    
    // Mettre à jour les graphiques avec les données
    function updateCharts(data) {
        if (!data || !data.stats) return;
        
        // Mettre à jour le graphique des niveaux de log
        if (data.stats.levels) {
            levelChart.data.datasets[0].data = [
                data.stats.levels.DEBUG || 0,
                data.stats.levels.INFO || 0,
                data.stats.levels.WARNING || 0,
                data.stats.levels.ERROR || 0,
                data.stats.levels.CRITICAL || 0
            ];
            levelChart.update();
        }
        
        // Mettre à jour le graphique des composants
        if (data.stats.components) {
            const components = Object.keys(data.stats.components);
            const counts = components.map(c => data.stats.components[c]);
            
            componentChart.data.labels = components;
            componentChart.data.datasets[0].data = counts;
            componentChart.update();
        }
    }
    
    // Initialiser les événements
    function initEvents() {
        // Actualiser les logs
        refreshBtn.addEventListener('click', loadLogs);
        
        // Filtrage par recherche textuelle
        logSearch.addEventListener('input', applyFilters);
        
        // Filtrage par composant
        logComponentSelect.addEventListener('change', applyFilters);
        
        // Filtrage par date
        logDateInput.addEventListener('change', applyFilters);
        
        // Effacer les filtres
        clearFiltersBtn.addEventListener('click', function() {
            logSearch.value = '';
            logComponentSelect.value = '';
            logDateInput.value = '';
            applyFilters();
        });
        
        // Télécharger les logs
        downloadBtn.addEventListener('click', function() {
            // Dans une implémentation réelle, rediriger vers un endpoint qui génère un fichier de logs
            location.href = '/api/logs/download';
        });
        
        // Effacer les logs
        clearLogsBtn.addEventListener('click', function() {
            if (confirm('Voulez-vous vraiment effacer tous les journaux? Cette action ne peut pas être annulée.')) {
                fetch('/api/logs/clear', { method: 'POST' })
                    .then(response => {
                        if (!response.ok) throw new Error('Échec de la suppression');
                        showToast('Logs effacés', 'Les journaux ont été effacés avec succès');
                        loadLogs();
                    })
                    .catch(error => {
                        showToast('Erreur', 'Impossible d\'effacer les journaux: ' + error.message, 'error');
                    });
            }
        });
        
        // Changer de niveau de log
        levelDropdown.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const level = this.getAttribute('data-level');
                currentLogLevel = level;
                document.getElementById('log-level-dropdown').textContent = 'Niveau: ' + level;
                loadLogs();
            });
        });
        
        // Toggle autoscroll
        toggleAutoscroll.addEventListener('click', function() {
            autoScroll = !autoScroll;
            this.classList.toggle('btn-outline-secondary');
            this.classList.toggle('btn-secondary');
            
            if (autoScroll) {
                logEntries.scrollTop = logEntries.scrollHeight;
            }
        });
    }
    
    // Fonction pour afficher un toast
    function showToast(title, message, type = 'info') {
        const toast = document.getElementById('notificationToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastTime = document.getElementById('toastTime');
        
        if (!toast) return;
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        toastTime.textContent = 'À l\'instant';
        
        // Ajouter la classe correspondant au type
        toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
        switch (type) {
            case 'success': toast.classList.add('bg-success'); break;
            case 'error': toast.classList.add('bg-danger'); break;
            case 'warning': toast.classList.add('bg-warning'); break;
            default: toast.classList.add('bg-info');
        }
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        return bsToast;
    }
    
    // Colorisation des niveaux de log
    function colorizeLogLevels() {
        const pre = logContent;
        let content = pre.innerHTML;
        
        // Colorer les différents niveaux de log
        content = content.replace(/DEBUG:/g, '<span class="text-info">DEBUG:</span>');
        content = content.replace(/INFO:/g, '<span class="text-success">INFO:</span>');
        content = content.replace(/WARNING:/g, '<span class="text-warning">WARNING:</span>');
        content = content.replace(/ERROR:/g, '<span class="text-danger">ERROR:</span>');
        content = content.replace(/CRITICAL:/g, '<span class="text-purple">CRITICAL:</span>');
        
        pre.innerHTML = content;
    }
    
    // Initialiser l'interface
    initCharts();
    initEvents();
    loadLogs();
});
</script>

<style>
.log-container {
    border: 1px solid rgba(0,0,0,.125);
    border-radius: 0.25rem;
    overflow: hidden;
}

.log-filters {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,.125);
}

.log-entries {
    height: 350px;
    overflow-y: auto;
    background-color: #f8f9fa;
}

.log-entries pre {
    padding: 0.75rem;
    margin-bottom: 0;
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    color: #212529;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.text-purple {
    color: #6610f2;
}

.loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 200px;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}Modèles - Ollama Sync{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h2 class="mb-4">Gestion des Modèles</h2>
    </div>
</div>

<!-- Filtres et actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" id="modelSearchInput" placeholder="Rechercher un modèle...">
                        <button class="btn btn-outline-secondary" type="button" id="modelSearchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="btn-group ms-2">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            Filtrer par
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-filter="all">Tous les modèles</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="available">Disponibles</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="unavailable">Non disponibles</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-filter="local">Modèles locaux</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="downloaded">Modèles téléchargés</a></li>
                        </ul>
                    </div>
                    
                    <div class="ms-auto d-flex gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pullModelModal">
                            <i class="fas fa-download me-1"></i> Télécharger un modèle
                        </button>
                        <button class="btn btn-success auto-refresh-toggle" id="refreshModelsBtn" data-target="models-list" data-seconds="60">
                            <i class="fas fa-sync-alt me-1"></i> 
                            <span class="status-text">Actualisation auto</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des modèles -->
<div class="row" id="modelsContainer">
    {% for model in models %}
    <div class="col-md-6 col-xl-4 mb-4 model-item" data-model-name="{{ model.name }}" data-available="{{ model.available|lower }}" id="{{ model.name|replace(':', '-') }}">
        <div class="card h-100 model-card">
            <div class="card-header d-flex justify-content-between">
                <h5 class="card-title mb-0">{{ model.name }}</h5>
                <span class="badge bg-{% if model.available %}success{% else %}danger{% endif %}">
                    {{ model.available|yesno("Disponible,Non disponible") }}
                </span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Taille:</small>
                    <strong>{{ model.size|filesizeformat }}</strong>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Serveurs disponibles:</small>
                    <div>
                        {% if model.servers %}
                            {% for server in model.servers[:3] %}
                                <span class="badge bg-primary mb-1">{{ server }}</span>
                            {% endfor %}
                            {% if model.servers|length > 3 %}
                                <span class="badge bg-secondary">+{{ model.servers|length - 3 }}</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Aucun serveur</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Paramètres:</small>
                    <div class="d-flex flex-wrap gap-1">
                        <span class="badge bg-light text-dark">{{ model.parameters|default('N/A') }} paramètres</span>
                        <span class="badge bg-light text-dark">quantized: {{ model.quantized|yesno("oui,non") }}</span>
                    </div>
                </div>
                
                <div>
                    <small class="text-muted d-block mb-1">Dernière mise à jour:</small>
                    <span>{{ model.modified_at|default('Inconnue') }}</span>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <a href="/playground?model={{ model.name }}" class="btn btn-sm btn-success">
                        <i class="fas fa-play me-1"></i> Tester
                    </a>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-info model-info-btn" data-model="{{ model.name }}">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="copyModelPrompt('{{ model.name }}')">
                                <i class="fas fa-copy me-1"></i> Copier le prompt
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="distributeModel('{{ model.name }}')">
                                <i class="fas fa-server me-1"></i> Distribuer sur les serveurs
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteModel('{{ model.name }}')">
                                <i class="fas fa-trash me-1"></i> Supprimer
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Aucun modèle disponible. Utilisez le bouton "Télécharger un modèle" pour en ajouter.
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination si nécessaire -->
{% if models|length > 12 %}
<div class="row">
    <div class="col-12">
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Précédent</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Suivant</a>
                </li>
            </ul>
        </nav>
    </div>
</div>
{% endif %}

<!-- Modal pour télécharger un modèle -->
<div class="modal fade" id="pullModelModal" tabindex="-1" aria-labelledby="pullModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pullModelModalLabel">Télécharger un modèle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="pullModelForm">
                    <div class="mb-3">
                        <label for="modelName" class="form-label">Nom du modèle</label>
                        <input type="text" class="form-control" id="modelName" placeholder="ex: llama2, mistral, etc." required>
                        <div class="form-text">
                            Entrez le nom du modèle à télécharger depuis le catalogue Ollama.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="serverSelect" class="form-label">Serveur cible</label>
                        <select class="form-select" id="serverSelect" required>
                            <option value="" selected disabled>Sélectionner un serveur</option>
                            <option value="all">Tous les serveurs</option>
                            {% for server in servers %}
                                <option value="{{ server.address }}">{{ server.address }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Sélectionnez le serveur sur lequel vous souhaitez télécharger ce modèle.
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="insecureCheckbox">
                        <label class="form-check-label" for="insecureCheckbox">Autoriser les sources non sécurisées</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="pullModelBtn">Télécharger</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'informations sur le modèle -->
<div class="modal fade" id="modelInfoModal" tabindex="-1" aria-labelledby="modelInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modelInfoModalLabel">Informations du modèle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Informations générales</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Nom</th>
                                <td id="infoModelName"></td>
                            </tr>
                            <tr>
                                <th>Taille</th>
                                <td id="infoModelSize"></td>
                            </tr>
                            <tr>
                                <th>Paramètres</th>
                                <td id="infoModelParams"></td>
                            </tr>
                            <tr>
                                <th>Famille</th>
                                <td id="infoModelFamily"></td>
                            </tr>
                            <tr>
                                <th>Quantization</th>
                                <td id="infoModelQuant"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Disponibilité</h6>
                        <table class="table table-sm" id="infoServerTable">
                            <thead>
                                <tr>
                                    <th>Serveur</th>
                                    <th>État</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <h6>Template de prompt</h6>
                <pre class="bg-light p-3 mb-4" id="infoModelTemplate"></pre>
                
                <h6>Paramètres par défaut</h6>
                <pre class="bg-light p-3" id="infoModelDefaultParams"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModelModal" tabindex="-1" aria-labelledby="deleteModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModelModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer le modèle <strong id="deleteModelName"></strong> ?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i> 
                    Cette action supprimera le modèle de tous les serveurs où il est installé.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteModelBtn">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast pour les notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="modelToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <small id="toastTime">À l'instant</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Recherche de modèles
    const modelSearchInput = document.getElementById('modelSearchInput');
    const modelSearchBtn = document.getElementById('modelSearchBtn');
    
    function searchModels() {
        const query = modelSearchInput.value.toLowerCase();
        const modelItems = document.querySelectorAll('.model-item');
        
        modelItems.forEach(item => {
            const modelName = item.getAttribute('data-model-name').toLowerCase();
            if (modelName.includes(query)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    modelSearchBtn.addEventListener('click', searchModels);
    modelSearchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            searchModels();
        }
    });
    
    // Filtrage des modèles
    document.querySelectorAll('[data-filter]').forEach(filter => {
        filter.addEventListener('click', function(e) {
            e.preventDefault();
            const filterValue = this.getAttribute('data-filter');
            const modelItems = document.querySelectorAll('.model-item');
            
            modelItems.forEach(item => {
                const isAvailable = item.getAttribute('data-available') === 'true';
                
                switch(filterValue) {
                    case 'all':
                        item.style.display = '';
                        break;
                    case 'available':
                        item.style.display = isAvailable ? '' : 'none';
                        break;
                    case 'unavailable':
                        item.style.display = !isAvailable ? '' : 'none';
                        break;
                    // Logique pour les autres filtres
                    default:
                        item.style.display = '';
                }
            });
        });
    });
    
    // Fonction pour afficher les informations du modèle
    const modelInfoBtns = document.querySelectorAll('.model-info-btn');
    modelInfoBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const modelName = this.getAttribute('data-model');
            showModelInfo(modelName);
        });
    });
    
    function showModelInfo(modelName) {
        // Ici on ferait normalement un appel API pour obtenir les détails
        // Pour l'exemple, on va simuler une réponse
        
        // Mettre à jour le titre du modal
        document.getElementById('modelInfoModalLabel').textContent = `Informations: ${modelName}`;
        
        // Mettre à jour les informations générales
        document.getElementById('infoModelName').textContent = modelName;
        document.getElementById('infoModelSize').textContent = '4.8 GB';
        document.getElementById('infoModelParams').textContent = '7B';
        document.getElementById('infoModelFamily').textContent = modelName.includes('llama') ? 'LLaMA' : 'Unknown';
        document.getElementById('infoModelQuant').textContent = 'Q4_K_M';
        
        // Template de prompt (exemple)
        document.getElementById('infoModelTemplate').textContent = 
            `<s>[INST] {{prompt}} [/INST]</s>`;
        
        // Paramètres par défaut (exemple)
        document.getElementById('infoModelDefaultParams').textContent = 
            JSON.stringify({
                'temperature': 0.7,
                'top_k': 40,
                'top_p': 0.9,
                'stream': true,
                'max_tokens': 500
            }, null, 2);
        
        // Disponibilité sur les serveurs
        const serverTableBody = document.querySelector('#infoServerTable tbody');
        serverTableBody.innerHTML = '';
        
        // Simuler quelques serveurs pour l'exemple
        const serverStatus = [
            { server: 'localhost:50051', available: true },
            { server: '192.168.1.10:50051', available: true },
            { server: '192.168.1.5:50051', available: false }
        ];
        
        serverStatus.forEach(status => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${status.server}</td>
                <td><span class="badge bg-${status.available ? 'success' : 'danger'}">${status.available ? 'Disponible' : 'Non disponible'}</span></td>
            `;
            serverTableBody.appendChild(row);
        });
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('modelInfoModal'));
        modal.show();
    }
    
    // Fonctions pour copier le prompt
    window.copyModelPrompt = function(modelName) {
        // Simuler la copie du prompt
        navigator.clipboard.writeText(`<s>[INST] {{prompt}} [/INST]</s>`)
            .then(() => {
                showToast('Succès', 'Template de prompt copié dans le presse-papier', 'success');
            })
            .catch(err => {
                console.error('Erreur lors de la copie :', err);
                showToast('Erreur', 'Impossible de copier le template', 'error');
            });
    };
    
    // Fonction pour distribuer le modèle
    window.distributeModel = function(modelName) {
        showToast('Distribution en cours', `Distribution de ${modelName} sur tous les serveurs...`, 'info');
        
        // Ici on simulerait un appel API pour distribuer le modèle
        setTimeout(() => {
            showToast('Distribution terminée', `${modelName} a été distribué avec succès`, 'success');
        }, 2000);
    };
    
    // Fonction pour supprimer un modèle
    window.deleteModel = function(modelName) {
        document.getElementById('deleteModelName').textContent = modelName;
        const modal = new bootstrap.Modal(document.getElementById('deleteModelModal'));
        modal.show();
    };
    
    // Gestion de la confirmation de suppression
    document.getElementById('confirmDeleteModelBtn').addEventListener('click', function() {
        const modelName = document.getElementById('deleteModelName').textContent;
        
        // Simuler la suppression
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModelModal'));
        modal.hide();
        
        // Afficher un indicateur de chargement
        showToast('Suppression en cours', `Suppression de ${modelName}...`, 'info');
        
        // Simuler un appel API pour supprimer le modèle
        setTimeout(() => {
            // Supprimer l'élément du DOM
            const modelElement = document.querySelector(`[data-model-name="${modelName}"]`);
            if (modelElement) {
                modelElement.remove();
            }
            
            showToast('Suppression terminée', `${modelName} a été supprimé avec succès`, 'success');
        }, 1500);
    });
    
    // Gestion du téléchargement de modèle
    document.getElementById('pullModelBtn').addEventListener('click', function() {
        const modelName = document.getElementById('modelName').value;
        const server = document.getElementById('serverSelect').value;
        const insecure = document.getElementById('insecureCheckbox').checked;
        
        if (!modelName || !server) {
            showToast('Erreur', 'Veuillez remplir tous les champs requis', 'error');
            return;
        }
        
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('pullModelModal'));
        modal.hide();
        
        // Simuler le téléchargement
        showToast('Téléchargement', `Téléchargement de ${modelName} en cours...`, 'info');
        
        // Dans un cas réel, on ferait un appel API ici
        setTimeout(() => {
            showToast('Téléchargement terminé', `${modelName} a été téléchargé avec succès`, 'success');
            
            // Recharger la page pour afficher le nouveau modèle
            // Dans un cas réel, on ajouterait dynamiquement le modèle à la liste
            setTimeout(() => {
                location.reload();
            }, 2000);
        }, 3000);
    });
    
    // Fonction pour afficher les toasts
    function showToast(title, message, type = 'info') {
        const toast = document.getElementById('modelToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white');
        
        switch(type) {
            case 'success':
                toast.classList.add('bg-success', 'text-white');
                break;
            case 'error':
                toast.classList.add('bg-danger', 'text-white');
                break;
            case 'warning':
                toast.classList.add('bg-warning');
                break;
            case 'info':
            default:
                toast.classList.add('bg-info', 'text-white');
                break;
        }
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    // Activer l'actualisation automatique
    document.getElementById('refreshModelsBtn').addEventListener('click', function() {
        this.classList.toggle('active');
        const isActive = this.classList.contains('active');
        const statusText = this.querySelector('.status-text');
        
        if (isActive) {
            statusText.textContent = 'Actualisation active';
            // Dans un cas réel, on mettrait en place un appel périodique à l'API
        } else {
            statusText.textContent = 'Actualisation auto';
        }
    });
});
</script>
{% endblock %}
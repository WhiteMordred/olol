{% extends "base.html" %}

{% block title %}Dashboard - OLOL Proxy{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h2 class="mb-4">Tableau de bord</h2>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card bg-primary text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Serveurs</h5>
                        <h2>{{ stats.servers.total }}</h2>
                    </div>
                    <div>
                        <i class="fas fa-server fa-3x icon-bg"></i>
                    </div>
                </div>
                <div class="mt-2 small">
                    <span class="text-success me-2">
                        <i class="fas fa-check-circle"></i> {{ stats.servers.healthy }} en ligne
                    </span>
                    <span class="text-danger">
                        <i class="fas fa-times-circle"></i> {{ stats.servers.total - stats.servers.healthy }} hors ligne
                    </span>
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="/servers">Voir les détails</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card bg-success text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Modèles</h5>
                        <h2>{{ stats.models.total }}</h2>
                    </div>
                    <div>
                        <i class="fas fa-brain fa-3x icon-bg"></i>
                    </div>
                </div>
                <div class="mt-2 small">
                    <span class="text-white me-2">
                        <i class="fas fa-check-circle"></i> {{ stats.models.available }} disponibles
                    </span>
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="/models">Voir les modèles</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card bg-warning text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Charge moyenne</h5>
                        <h2>{{ "%.1f"|format(stats.load.average * 100) }}%</h2>
                    </div>
                    <div>
                        <i class="fas fa-tachometer-alt fa-3x icon-bg"></i>
                    </div>
                </div>
                <div class="mt-2 small">
                    <span class="text-white me-2">
                        <i class="fas fa-arrow-up"></i> Max: {{ "%.1f"|format(stats.load.max * 100) }}%
                    </span>
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="/health">Voir les performances</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card bg-info text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Temps de disponibilité</h5>
                        <h2>{{ stats.uptime }}</h2>
                    </div>
                    <div>
                        <i class="fas fa-clock fa-3x icon-bg"></i>
                    </div>
                </div>
                <div class="mt-2 small">
                    <span class="text-white me-2">
                        <i class="fas fa-code-branch"></i> Version {{ stats.version }}
                    </span>
                </div>
            </div>
            <div class="card-footer d-flex align-items-center justify-content-between">
                <a class="small text-white stretched-link" href="/settings">Paramètres</a>
                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Server Health and Charts -->
<div class="row">
    <!-- Server Health Overview -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-chart-bar me-1"></i>
                    Historique de charge de serveurs
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary auto-refresh-toggle" data-target="load-chart" data-seconds="30">
                        <i class="fas fa-sync-alt me-1"></i>
                        <span class="status-text">Actualisation auto</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="loadChartCanvas" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Server Status Overview -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-server me-1"></i>
                    État des serveurs
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary auto-refresh-toggle" data-target="servers-status" data-seconds="30">
                        <i class="fas fa-sync-alt me-1"></i>
                        <span class="status-text">Actualisation auto</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Serveur</th>
                                <th>État</th>
                                <th>Charge</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for server in servers[:5] %}
                            <tr>
                                <td>{{ server.address }}</td>
                                <td>
                                    {% if server.healthy %}
                                    <span class="badge bg-success">En ligne</span>
                                    {% else %}
                                    <span class="badge bg-danger">Hors ligne</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar 
                                        {% if server.load < 0.5 %}bg-success
                                        {% elif server.load < 0.8 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                        style="width: {{ server.load * 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(server.load * 100) }}%</small>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">Aucun serveur disponible</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if servers|length > 5 %}
                <div class="text-center mt-2">
                    <a href="/servers" class="btn btn-sm btn-outline-primary">Voir tous ({{ servers|length }})</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Popular Models and Health Status -->
<div class="row">
    <!-- Popular Models -->
    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-brain me-1"></i>
                Modèles populaires
            </div>
            <div class="card-body">
                <div class="row">
                    {% for model in popular_models %}
                    <div class="col-md-6 mb-3">
                        <div class="card model-card h-100">
                            <div class="card-body">
                                <h5 class="model-name">{{ model.name }}</h5>
                                <div class="model-info mb-2">
                                    <span class="badge bg-{% if model.available %}success{% else %}danger{% endif %}">
                                        {% if model.available %}Disponible{% else %}Non disponible{% endif %}
                                    </span>
                                    <span class="badge bg-secondary">{{ model.servers|length }} serveur(s)</span>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <a href="/playground?model={{ model.name }}" class="btn btn-sm btn-success me-1">
                                        <i class="fas fa-play"></i>
                                    </a>
                                    <a href="/models#{{ model.name }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-info-circle"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12">
                        <div class="alert alert-info mb-0">Aucun modèle disponible</div>
                    </div>
                    {% endfor %}
                </div>
                <div class="text-center mt-3">
                    <a href="/models" class="btn btn-outline-primary">Voir tous les modèles</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <div class="d-flex">
                <div class="me-3">
                    <i class="fas fa-info-circle fa-2x"></i>
                </div>
                <div>
                    <h5>Conseils pour le proxy OLOL</h5>
                    <p class="mb-0">
                        Pour optimiser les performances de votre cluster, assurez-vous que les serveurs ont des ressources équilibrées
                        et que les modèles les plus utilisés sont répliqués sur plusieurs serveurs.
                        <a href="/settings" class="alert-link">Configurez les paramètres avancés</a> pour une meilleure distribution des charges.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Charger les données de charge
    const loadChartData = {{ load_chart_data|tojson }};
    const loadCtx = document.getElementById('loadChartCanvas').getContext('2d');
    
    // Créer le graphique de charge
    const loadChart = new Chart(loadCtx, {
        type: 'line',
        data: loadChartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1,
                    ticks: {
                        callback: function(value) {
                            return Math.round(value * 100) + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += Math.round(context.parsed.y * 100) + '%';
                            return label;
                        }
                    }
                }
            }
        }
    });
    
    // Charger les données de santé
    const healthChartData = {{ health_chart_data|tojson }};
    const healthCtx = document.getElementById('healthChartCanvas').getContext('2d');
    
    // Créer le graphique de santé
    const healthChart = new Chart(healthCtx, {
        type: 'line',
        data: healthChartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1,
                    ticks: {
                        callback: function(value) {
                            return value === 0 ? 'Hors ligne' : 'En ligne';
                        },
                        stepSize: 1
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y === 1 ? 'En ligne' : 'Hors ligne';
                            return label;
                        }
                    }
                }
            }
        }
    });
    
    // Gestionnaires pour l'actualisation automatique
    document.querySelectorAll('.auto-refresh-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('active');
            const isActive = this.classList.contains('active');
            const statusText = this.querySelector('.status-text');
            statusText.textContent = isActive ? 'Actif' : 'Actualisation auto';
            
            // Logique d'actualisation
            const target = this.getAttribute('data-target');
            const seconds = parseInt(this.getAttribute('data-seconds'), 10);
            
            if (target === 'load-chart') {
                if (isActive) {
                    // Démarrer l'actualisation
                    window.loadChartRefresh = setInterval(function() {
                        // Simuler une actualisation des données
                        loadChartData.datasets.forEach(dataset => {
                            dataset.data = dataset.data.slice(1);
                            const randomValue = Math.random() * 0.1 + 
                                (parseFloat(dataset.data[dataset.data.length - 1]) || 0.5);
                            dataset.data.push(Math.min(1, Math.max(0, randomValue)));
                        });
                        loadChart.update();
                    }, seconds * 1000);
                } else {
                    // Arrêter l'actualisation
                    clearInterval(window.loadChartRefresh);
                }
            }
            
            if (target === 'health-status' || target === 'servers-status') {
                if (isActive) {
                    // En production, ceci ferait un appel API pour actualiser les données
                    window[target + 'Refresh'] = setInterval(function() {
                        console.log('Actualisation des données de ' + target);
                        // Dans une implémentation réelle, on ferait un appel fetch() ici
                    }, seconds * 1000);
                } else {
                    clearInterval(window[target + 'Refresh']);
                }
            }
        });
    });
});
</script>
{% endblock %}